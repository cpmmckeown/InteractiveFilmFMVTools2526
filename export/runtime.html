<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive FMV Runtime</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    video {
      width: 100%;
      max-width: 960px;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    #choices {
      margin-top: 20px;
    }
    button {
      background: #222;
      color: #fff;
      border: 1px solid #555;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #444;
    }
  </style>
</head>
<body>

  <!-- Inline project data (optional) -->
  <!-- The authoring tool can inject JSON here for standalone exports -->
  <!-- <script id="projectData" type="application/json">{ ... }</script> -->

  <video id="videoPlayer" controls></video>
  <div id="choices"></div>

  <script>
    let projectData = null;
    let currentScene = null;
    let variables = {};

    // Entry point
    init();

    function init() {
      // Check for inline JSON first
      const inline = document.getElementById("projectData");
      if (inline) {
        projectData = JSON.parse(inline.textContent);
        variables = structuredClone(projectData.variables || {});
        loadScene(projectData.project.startScene);
      } else {
        // Fall back to external project.json
        fetch("project.json")
          .then(res => res.json())
          .then(data => {
            projectData = data;
            variables = structuredClone(projectData.variables || {});
            loadScene(projectData.project.startScene);
          })
          .catch(err => {
            alert("Error loading project.json: " + err);
          });
      }
    }

    function loadScene(sceneId) {
      const scene = projectData.scenes.find(s => s.id === sceneId);
      if (!scene) {
        alert("Scene not found: " + sceneId);
        return;
      }
      currentScene = scene;

      // Load video
      const video = document.getElementById("videoPlayer");
      video.src = projectData.project.mediaPath + scene.video;
      video.play();

      // Clear choices
      const choiceContainer = document.getElementById("choices");
      choiceContainer.innerHTML = "";

      // Show choices when video ends
      video.onended = () => {
        showChoices(scene);
      };
    }

    function showChoices(scene) {
      const choiceContainer = document.getElementById("choices");
      choiceContainer.innerHTML = "";

      scene.choices.forEach(choice => {
        if (checkConditions(choice.conditions || [])) {
          const btn = document.createElement("button");
          btn.textContent = choice.label;
          btn.onclick = () => {
            applyEffects(choice.effects || {});
            loadScene(choice.next);
          };
          choiceContainer.appendChild(btn);
        }
      });
    }

    function checkConditions(conditions) {
      if (!conditions || conditions.length === 0) return true;
      return conditions.every(cond => {
        try {
          const [key, operator, value] = cond.split(" ");
          if (!(key in variables)) return false;
          const variable = variables[key];
          switch (operator) {
            case "==": return variable == JSON.parse(value);
            case "!=": return variable != JSON.parse(value);
            case ">": return variable > JSON.parse(value);
            case "<": return variable < JSON.parse(value);
            case ">=": return variable >= JSON.parse(value);
            case "<=": return variable <= JSON.parse(value);
            default: return false;
          }
        } catch {
          return false;
        }
      });
    }

    function applyEffects(effects) {
      for (let key in effects) {
        const effect = effects[key];
        if (typeof variables[key] === "number") {
          if (effect.startsWith("+")) {
            variables[key] += parseInt(effect.substring(1));
          } else if (effect.startsWith("-")) {
            variables[key] -= parseInt(effect.substring(1));
          } else {
            variables[key] = parseInt(effect);
          }
        } else if (typeof variables[key] === "boolean") {
          variables[key] = (effect === "true");
        } else {
          variables[key] = effect; // strings
        }
      }
    }
  </script>
</body>
</html>
